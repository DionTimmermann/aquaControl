<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=""> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8" lang=""> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9" lang=""> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang=""> <!--<![endif]-->
    <head>
        <base href="/static/">
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title></title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="stylesheet" href="css/bootstrap.min.css">
        <link rel="stylesheet" href="css/bootstrap-theme.min.css">
        <link rel="stylesheet" href="css/bootstrap-slider.min.css">
        <link rel="stylesheet" href="css/bootstrap-clockpicker.min.css">
        <link rel="stylesheet" href="css/main.css">

        <style>
            body {
                padding-top: 50px;
                padding-bottom: 20px;
            }

            .slider.slider-horizontal {
              width: 100%;
              margin-top: 6px;
            }

            .glyphicon.spinning {
                animation: spin 1s infinite linear;
                -webkit-animation: spin2 1s infinite linear;
            }

            @keyframes spin {
                from { transform: scale(1) rotate(0deg); }
                to { transform: scale(1) rotate(360deg); }
            }

            @-webkit-keyframes spin2 {
                from { -webkit-transform: rotate(0deg); }
                to { -webkit-transform: rotate(360deg); }
            }
        </style>

        <script src="js/vendor/modernizr-2.8.3-respond-1.4.2.min.js"></script>
    </head>
    <body>
        <!--[if lt IE 8]>
            <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container-fluid">
        <div class="row">
          <div class="col-sm-6">
            <a class="navbar-brand" href="#">Aquarium Bad</a>
          </div>
          <div class="col-sm-6">
            <button style="margin-top:8px;" type="submit" class="btn btn-danger pull-right" data-toggle="modal" data-target="#modalMaintenance">Wasserwechsel</button>
          </div>
        </div>
    </nav>

    <div class="container-fluid" style="min-width:350px;">
      <!-- Example row of columns -->
      <br>
      <div class="row">

        <div class="col-sm-6">
          <div class="panel panel-default">
            <div class="panel-heading">
              <span id="sensorDataLight" class="label label-default pull-right">??</span>
              <h3 class="panel-title">Licht</h3>
            </div>
            <div class="panel-body">
              <div class="row">
                <div class="col-xs-5 btn-group" data-toggle="buttons">
                  <a id="lightManualToggle" class="btn btn-default btn-block" style="overflow:hidden;" autocomplete="off">
                    Manuell
                  </a>
                </div>
                <div class="col-xs-7">
                  <div style="margin-right:10px;">
                    <input
                      type="text"
                      id="lightManualSlider"
                      class="slider"
                    >
                  </div>
                </div>
              </div>
              <hr>
              &nbsp;<strong>Zeitplan:</strong><br>
              <ul id="lightNodeList" class="list-group">
                <li class="list-group-item">
                  <span class="glyphicon glyphicon-refresh spinning"></span>
                </li>
              </ul>
              <button type="button" class="btn btn-success" data-toggle="modal" data-id="-1" data-target="#modalLightNode">Eintrag Hinzufügen</button>
            </div>
          </div>
        </div>

        <div class="col-sm-6">
          <div class="panel panel-default">
            <div class="panel-heading">
              <span id="sensorDataCO2Valve" class="label label-default pull-right">??</span>
              <h3 class="panel-title">pH &amp; CO<sub>2</sub></h3>
            </div>
            <div class="panel-body">

              <table class="table">
                <thead>
                  <tr>
                    <th>Parameter</th>
                    <th>Wert</th>
                    <th>Soll</th>
                </thead>
                <tbody>
                  <tr>
                    <td>
                      pH
                    </td>
                    <td id='sensorDataPH'>
                      <span class="glyphicon glyphicon-refresh spinning"></span>
                    </td>
                    <td id='sensorDataPHgoal'>
                      <span class="glyphicon glyphicon-refresh spinning"></span>
                    </td>
                  </tr>
                  <tr>
                    <td>
                      CO<sub>2</sub>
                    </td>
                    <td id='sensorDataCO2'>
                      <span class="glyphicon glyphicon-refresh spinning"></span>
                    </td>
                    <td id='sensorDataCO2goal'>
                      <span class="glyphicon glyphicon-refresh spinning"></span>
                    </td>
                  </tr>
                  <tr>
                    <td>
                      Temp.
                    </td>
                    <td id='sensorDataTemp'>
                      <span class="glyphicon glyphicon-refresh spinning"></span>
                    </td>
                    <td style="color:#999;">
                      N.A.
                    </td>
                  </tr>
                </tbody>
              </table>

              <div class="row">
                <div class="col-sm-12">
                  <button type="button" class="btn btn-warning pull-right" data-toggle="modal" data-target="#modalPhCal">Kalibrieren</button>
                  <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#modalPhConf">Konfigurieren</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-sm-6">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Düngung</h3>
            </div>
            <div class="panel-body">

              <table class="table">
                <thead>
                  <tr>
                    <th>Dünger</th>
                    <th>Verbleibend</th>
                    <th>&nbsp;</th>
                </thead>
                <tbody id="pumpTable">
                  <tr>
                    <td colspan="3">
                      <span class="glyphicon glyphicon-refresh spinning"></span>
                    </td>
                  </tr>
                </tbody>
              </table>

              <hr>

              &nbsp;<strong>Zeitplan:</strong><br>
              <ul id="pumpNodeList" class="list-group">
                <li class="list-group-item">
                  <span class="glyphicon glyphicon-refresh spinning"></span>
                </li>
              </ul>

              <button type="button" class="btn btn-success" data-toggle="modal" data-id="-1" data-target="#modalPumpNode">Düngung Hinzufügen</button>

            </div>
          </div>
        </div>
      </div>

      <hr>

      <footer>
        <p>&copy; Dion Timmermann 2016</p>
      </footer>
    </div> <!-- /container -->

    <!-- Modal for Light-Node -->
    <div class="modal fade" id="modalLightNode" tabindex="-1" role="dialog" data-backdrop="static" aria-labelledby="myModalLabel">
      <div class="modal-dialog modal-sm" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">Modal title</h4>
          </div>
          <div class="modal-body form-horizontal">
            <div class="row">
              <div class="col-sm-12">
                <div id='errorMsg' class="alert alert-danger text-center hidden" role="alert"></div>
              </div>
            </div>
            <input type="hidden" name="id">
            <div class="form-group">
              <label for="time" class="col-sm-4 control-label">Uhrzeit:</label>
              <div class="col-sm-8">
                <div class="input-group clockpicker" data-autoclose="true">
                    <input name="time" type="text" class="form-control" value="13:14">
                    <span class="input-group-addon">
                        <span class="glyphicon glyphicon-time"></span>
                    </span>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label for="brightness" class="col-sm-4 control-label">Helligkeit:</label>
              <div class="col-sm-8">
                <input type="text" class="slider form-control" name="brightness">
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" name="delete" class="btn btn-danger pull-left">Löschen</button>
          <!--  <button type="button" class="btn btn-default" data-dismiss="modal">Schließen</button> -->
            <button type="button" name="save" class="btn btn-primary">Speichern</button>
          </div>
        </div>
      </div>
    </div>


    <!-- Modal for pH-Conf -->
    <div class="modal fade" id="modalPhConf" tabindex="-1" role="dialog" data-backdrop="static" aria-labelledby="myModalLabel">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">pH &amp; CO<sub>2</sub> konfigurieren</h4>
          </div>
          <div class="modal-body form-horizontal">
            <div class="form-group">
              <label for="" class="col-sm-2 control-label">Sollwert:</label>
              <div class="col-sm-3">
                <div class="input-group">
                  <input type="number" name="pHmean" class="form-control" min="0" max="14" step="0.1">
                  <div class="input-group-addon">pH</div>
                </div>
              </div>
              <div class="col-sm-1 text-center">
                &pm;
              </div>
              <div class="col-sm-3">
                <div class="input-group">
                  <input type="number" name="pHpm" class="form-control" min="0" max="14" step="0.01">
                  <div class="input-group-addon">pH</div>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label for="" class="col-sm-2 control-label"></label>
              <div class="col-sm-3" id="co2pHmean" style="padding-left:2em;">
                0 mg/l
              </div>
              <div class="col-sm-1 text-center">

              </div>
              <div class="col-sm-6" id="co2pHpm" style="padding-left:1.5em;">
                0 mg/l
              </div>
            </div>
            <div class="form-group">
              <label for="" class="col-sm-2 control-label">Übersicht:</label>
              <div class="col-sm-8">
                <table class="table" style="width: auto !important;">
                  <thead>
                    <tr>
                      <th>CO<sub>2</sub></th>
                      <th>pH</th>
                  </thead>
                  <tbody>
                    <tr>
                      <td>
                        5 mg/l
                      </td>
                      <td class="PHtable" data-co2="5">
                        <span class="glyphicon glyphicon-refresh spinning"></span>
                      </td>
                    </tr>
                    <tr>
                      <td>
                        10 mg/l
                      </td>
                      <td class="PHtable" data-co2="10">
                        <span class="glyphicon glyphicon-refresh spinning"></span>
                      </td>
                    </tr>
                    <tr>
                      <td>
                        20 mg/l
                      </td>
                      <td class="PHtable" data-co2="20">
                        <span class="glyphicon glyphicon-refresh spinning"></span>
                      </td>
                    </tr>
                    <tr>
                      <td>
                        30 mg/l
                      </td>
                      <td class="PHtable" data-co2="30">
                        <span class="glyphicon glyphicon-refresh spinning"></span>
                      </td>
                    </tr>
                    <tr>
                    <td>
                      40 mg/l
                    </td>
                    <td class="PHtable" data-co2="40">
                      <span class="glyphicon glyphicon-refresh spinning"></span>
                    </td>
                  </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="clearfix"></div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary">Speichern</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal for pH-Cal -->
    <div class="modal fade" id="modalPhCal" tabindex="-1" role="dialog" data-backdrop="static" aria-labelledby="myModalLabel">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">pH &amp; CO<sub>2</sub> kalibrieren</h4>
          </div>
          <div class="modal-body form-horizontal">
            <div class="row">
              <div class="col-sm-12">
                <div class="alert alert-info text-center" role="alert">Aktuell: <span id='currentPh'>?</span> mV</div>
              </div>
            </div>
            <div class="row">
              <div class="col-sm-12">
                <div id='errorMsg' class="alert alert-danger text-center hidden" role="alert"></div>
              </div>
            </div>
            <div class="form-group">
              <label for="" class="col-sm-2 control-label">Puffer 1:</label>
              <div class="col-sm-4">
                <div class="input-group">
                <div class="input-group-addon">pH</div>
                  <input type="number" class="form-control" name="pH1">
                </div>
              </div>
              <div class="col-sm-4">
                <div class="input-group">
                  <input type="number" class="form-control" name="mV1">
                  <div class="input-group-addon">mV</div>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label for="" class="col-sm-2 control-label">Puffer 2:</label>
              <div class="col-sm-4">
                <div class="input-group">
                <div class="input-group-addon">pH</div>
                  <input type="number" class="form-control" name="pH2">
                </div>
              </div>
              <div class="col-sm-4">
                <div class="input-group">
                  <input type="number" class="form-control" name="mV2">
                  <div class="input-group-addon">mV</div>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label for="" class="col-sm-2 control-label">kH:</label>
              <div class="col-sm-4">
                <div class="input-group">
                  <input type="number" class="form-control" name="kH">
                  <div class="input-group-addon">&deg;dH</div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" name="save" class="btn btn-primary">Speichern</button>
          </div>
        </div>
      </div>
    </div>


    <!-- Modal for Pump-Node -->
    <div class="modal fade" id="modalPumpNode" tabindex="-1" role="dialog" data-backdrop="static" aria-labelledby="myModalLabel">
      <div class="modal-dialog modal-sm" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">Düngung einstellen</h4>
          </div>
          <div class="modal-body form-horizontal">
            <div class="row">
              <div class="col-sm-12">
                <div id='errorMsg' class="alert alert-danger text-center hidden" role="alert"></div>
              </div>
            </div>
            <input type="hidden" name='id'>
            <div class="form-group">
              <label for="" class="col-sm-4 control-label">Name:</label>
              <div class="col-sm-8">
                <select id="pumpSelect" name='pump' class="form-control">
                  <option>Fe</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label for="" class="col-sm-4 control-label">Uhrzeit:</label>
              <div class="col-sm-8">
                <div class="input-group clockpicker" data-autoclose="true">
                    <input type="text" name='time' class="form-control" value="13:14">
                    <span class="input-group-addon">
                        <span class="glyphicon glyphicon-time"></span>
                    </span>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label for="" class="col-sm-4 control-label">Menge:</label>
              <div class="col-sm-8">
                <div class="input-group">
                  <input type="number" name='amount' class="form-control" id="exampleInputAmount" placeholder="Amount">
                  <div class="input-group-addon">ml</div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" name="delete" class="btn btn-danger pull-left">Löschen</button>
            <button type="button" name='save' class="btn btn-primary">Speichern</button>
          </div>
        </div>
      </div>
    </div>


    <!-- Modal for Pump-Cal -->
    <div class="modal fade" id="modalPumpCal" tabindex="-1" role="dialog" data-backdrop="static" aria-labelledby="myModalLabel">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">Düngung kalibrieren</h4>
          </div>
          <form>
          <div class="modal-body form-horizontal">
            <div class="row">
              <div class="col-sm-12">
                <div id='errorMsg' class="alert alert-danger text-center hidden" role="alert"></div>
              </div>
            </div>
            <input type="hidden" name='id'>

            <div class="form-group">
              <label for="" class="col-sm-3 control-label">Name:</label>
              <div class="col-sm-9">
                <input type="text" name='name' class="form-control">
              </div>
            </div>
            <div class="form-group">
              <label for="" class="col-sm-3 control-label">Dauerwert:</label>
              <div class="col-sm-5">
                <div class="input-group">
                  <input type="number" name="continuous" class="form-control">
                  <div class="input-group-addon">ml</div>
                </div>
              </div>
              <div class="col-sm-4">
                <button id='calibrateContinuous' class="btn btn-primary btn-block">Testen</button>
              </div>
            </div>
            <div class="form-group">
              <label for="" class="col-sm-3 control-label">Impulswert:</label>
              <div class="col-sm-5">
                <div class="input-group">
                  <input type="number" name="impulse" class="form-control" placeholder="Amount">
                  <div class="input-group-addon">ml</div>
                </div>
              </div>
              <div class="col-sm-4">
                <button id='calibrateImpulse' class="btn btn-primary btn-block">Testen</button>
              </div>
            </div>
            <div class="form-group">
              <label for="" class="col-sm-3 control-label">Verbleibend:</label>
              <div class="col-sm-9">
                <div class="input-group">
                  <input type="number" name="remaining" class="form-control" placeholder="Amount">
                  <div class="input-group-addon">ml</div>
                </div>
              </div>
            </div>

          </div>
          </form>
          <div class="modal-footer">
            <button name="save" type="button" class="btn btn-primary">Speichern</button>
          </div>
        </div>
      </div>
    </div>


        <!-- Modal for Pump-Cal -->
        <div class="modal fade" id="modalMaintenance" tabindex="-1" role="dialog" data-backdrop="static" aria-labelledby="myModalLabel">
          <div class="modal-dialog modal-md" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h4 class="modal-title">Wasserwechsel</h4>
              </div>
              <div class="modal-body form-horizontal">
                Solange dieses Fenster geöffnet ist, wird kein Dünger oder CO<sub>2</sub> hinzugefügt. Die Messwerte werden weiterhin aufgezeichnet. Beim Beenden werden die gewählten Mengen an Dünger hinzugefügt.
              </div>
              <div id='maintenanceForm' class="modal-body form-horizontal">

              </div>
              <div class="modal-footer">
                <button id='endMaintenance'type="button" name="end" class="btn btn-danger">Beenden</button>
              </div>
            </div>
          </div>
        </div>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="js/vendor/jquery-1.11.2.min.js"><\/script>')</script>

        <script src="js/vendor/bootstrap-slider.min.js"></script>
        <script src="js/vendor/bootstrap-clockpicker.min.js"></script>
        <script src="js/vendor/bootstrap.min.js"></script>


        <script type="text/javascript">


        jQuery["put"] = function( url, data, callback) {

          return jQuery.ajax({
            url: url,
            type: "put",
            data: JSON.stringify(data),
            contentType: "application/json",
            accepts: "application/json",
            cache: false,
            dataType: 'json',
            success: callback
          });
        };

        jQuery["jsonPost"] = function( url, data, callback) {

          return jQuery.ajax({
            url: url,
            type: "post",
            data: JSON.stringify(data),
            contentType: "application/json",
            accepts: "application/json",
            cache: false,
            dataType: 'json',
            success: callback
          });
        };

        jQuery[ "delete" ] = function( url, callback) {

          return jQuery.ajax({
            url: url,
            type: "delete",
            contentType: "application/json",
            accepts: "application/json",
            cache: false,
            dataType: 'json',
            success: callback
          });
        };

        var lightManual = false;
        var newLightManualVal = null;
        var newLightManualValUpdating = false;

        function lightManualToggleBtnUpdate() {
          if (lightManual) {
            $('#lightManualToggle').removeClass('btn-default');
            $('#lightManualToggle').addClass('btn-warning');
            $('#lightManualToggle').addClass('active');
          } else {
            $('#lightManualToggle').removeClass('active');
            $('#lightManualToggle').removeClass('btn-warning');
            $('#lightManualToggle').addClass('btn-default');
          }
        }

        function updateLightNodes(nodes) {
          $("#lightNodeList").empty();

          $.each(nodes, function(index, node) {
            $("#lightNodeList").append(`\n
              <li class="list-group-item">
              ${node['time']} Uhr - ${Math.round(node['brightness']*100)}%
              <button type="button" class="btn btn-primary btn-xs pull-right" data-toggle="modal" data-id="${node['id']}" data-target="#modalLightNode">Bearbeiten</button>
              </li>`);
          });
        }

        function updatePumpNodes(nodes) {
          $("#pumpNodeList").empty();

          $.each(nodes, function(index, node) {
            $("#pumpNodeList").append(`\n
              <li class="list-group-item">
              ${node['time']} Uhr - ${node['amount']}ml ${node['pumpName']}
              <button type="button" class="btn btn-primary btn-xs pull-right" data-toggle="modal" data-id="${node['id']}" data-target="#modalPumpNode">Bearbeiten</button>
              </li>`);
          });
        }

        function updatePumpTable(cal) {
          $("#pumpTable").empty();

          $.each(cal, function(index, pump) {
            $("#pumpTable").append(`
                <tr>
                  <td>${pump['name']}</td>
                  <td>${pump['remaining']}ml</td>
                  <td><button type="button" class="btn btn-primary btn-xs pull-right" data-toggle="modal" data-id="${pump['id']}" data-target="#modalPumpCal">Bearbeiten</button></td>
                </tr>`);
          });


          $("#pumpSelect").empty();

          $.each(cal, function(index, pump) {
            $("#pumpSelect").append(`
                <option value='${pump['id']}'>${pump['name']}</option>`);
          });


          $("#maintenanceForm").empty();

          $.each(cal, function(index, pump) {
            $("#maintenanceForm").append(`
                  <div class="form-group">
                    <label for="" class="col-sm-4 control-label">${pump['name']}:</label>
                    <div class="col-sm-8">
                      <div class="input-group">
                        <input type="number" data-pump="${pump['id']}" class="form-control pump-amount" placeholder="Menge">
                        <div class="input-group-addon">ml</div>
                      </div>
                    </div>
                  </div>`);
          });

        }

        function setLightManualVal() {
          newLightManualValUpdating = true;
          tmp = newLightManualVal;
          newLightManualVal = null;
          $.put('/api/light/manual/brightness', {brightness: tmp}).done(function() {
            newLightManualValUpdating = false;
            if (newLightManualVal != null) {
              setTimeout(setLightManualVal, 1);
            }
          });
        }

        var kH = null;

        // from: http://www.deters-ing.de/Wasser/co2.htm
        function PHfromCO2andKH(CO2, kH) {
          return 7.9 - Math.log10(2.8 * CO2 / kH);
        }
        // from: http://www.deters-ing.de/Wasser/co2.htm
        function CO2fromPHandKH(pH, kH) {
          return kH / 2.8 * Math.pow(10, 7.9 - pH);
        }

        function updatePHlist() {
          $('.PHtable').each(function(index) {
            //alert($(this).data('co2'));
            $(this).text(PHfromCO2andKH($(this).data('co2'), kH).toFixed(2));
          });
        }

        function updateCO2() {
          pHmean = parseFloat($('#modalPhConf input[name=pHmean]').val());
          pHpm = parseFloat($('#modalPhConf input[name=pHpm]').val());
          pHmin = pHmean - pHpm;
          pHmax = pHmean + pHpm;

          co2mean = CO2fromPHandKH(pHmean, kH);
          co2max = CO2fromPHandKH(pHmin, kH);
          co2min = CO2fromPHandKH(pHmax, kH);
          co2m = co2max - co2mean;
          co2p = co2mean - co2min;

          $('#co2pHmean').text(co2mean.toFixed(2) + ' mg/l');
          $('#co2pHpm').text('-' + co2m.toFixed(2) + ' mg/l bzw. +' + co2p.toFixed(2) + ' mg/l');
        }

        var phCalVisible = false;

        function updatePhCalValues() {
          if (!phCalVisible) {
            return;
          }

          $.get('/api/ph/current', function(data){
            $('#currentPh').text(data.mV.toFixed(2));
          }).done(function() {
            setTimeout(updatePhCalValues, 1000);
          });

        }

        function updateSensors() {
          $.get('/api/sensors', function(data){
            //$('#sensorDataLight').text(data.light.toFixed(0) + ' lm');
            /*if (data.light.toFixed(0) > 0) {
              $('#sensorDataLight').removeClass('label-default').addClass('label-warning');
            } else {
              $('#sensorDataLight').addClass('label-default').removeClass('label-warning');
            }*/

            if (data.CO2valve) {
              $('#sensorDataCO2Valve').text('An');
              $('#sensorDataCO2Valve').removeClass('label-default').addClass('label-warning');
            } else {
              $('#sensorDataCO2Valve').text('Aus');
              $('#sensorDataCO2Valve').addClass('label-default').removeClass('label-warning');
            }

            $('#sensorDataPH').text(data.pH.toFixed(2));
            $('#sensorDataPHgoal').text(data.pHgoal.toFixed(2));
            $('#sensorDataCO2').html(data.CO2.toFixed(1) + ' <sup>mg</sup>/<sub>l</sub>');
            $('#sensorDataCO2goal').html(data.CO2goal.toFixed(1) + ' <sup>mg</sup>/<sub>l</sub>');
            $('#sensorDataTemp').html(data.temperature.toFixed(0) + ' &#8451;');

          }).done(function() {
            setTimeout(updateSensors, 60*1000);
          });
        }

        $( document ).ready(function() {

          updateSensors();

          $('.clockpicker').clockpicker();

          $('#lightManualToggle').click(function( event ) {
            lightManual = !lightManual;
            $.put('/api/light/manual/on', {on: lightManual}, function(result){
               lightManualToggleBtnUpdate();
            });
          });

          $('.slider').slider({
          	formatter: function(value) {
          		return Math.round(value*100)+'%';
          	},
            min:0.0,
            max:1.0,
            step:0.01,
            tooltip_position:'bottom'
          });

          $.get('/api/light/manual/brightness', function(data){
             $('#lightManualSlider').slider('setValue', data.brightness);
          });


          $.get('/api/light/manual/on', function(data){
             lightManual = data.on;
             lightManualToggleBtnUpdate();
          });

          $.get('/api/light/nodes', function(data){
             updateLightNodes(data.nodes);
          });

          $.get('/api/pumps/nodes', function(data){
             updatePumpNodes(data.nodes);
          });

          $.get('/api/pumps/cal', function(data){
             updatePumpTable(data.cal);
          });

          $('#lightManualSlider').change(function() {
            newLightManualVal = parseFloat($('#lightManualSlider').val());
            if (!newLightManualValUpdating) {
              setTimeout(setLightManualVal, 1);
            }
          });

          $('#modalPhConf input').keypress(updateCO2);
          $('#modalPhConf input').change(updateCO2);

          $('#modalPhCal').on('show.bs.modal', function (event) {

            var modal = $(this)

            $.get('/api/ph/cal', function(data){
              modal.find('input[name=pH1]').val(data['pH1']);
              modal.find('input[name=pH2]').val(data['pH2']);
              modal.find('input[name=mV1]').val(data['mV1']);
              modal.find('input[name=mV2]').val(data['mV2']);
              modal.find('input[name=kH]').val(data['kH']);
            });

            phCalVisible = true;
            updatePhCalValues();

          });

          $('#modalPhCal').on('hide.bs.modal', function (event) {
            phCalVisible = false;

          });

          $.get('/api/ph/cal', function(data){
            kH = parseFloat(data['kH']);
            updatePHlist();
          });

          $('#modalPumpCal').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget) // Button that triggered the modal
            var id = button.data('id') // Extract info from data-* attributes

            var modal = $(this)

            $.get('/api/pumps/cal/'+id, function(data){
              modal.find('input[name=id]').val(data['id']);
              modal.find('input[name=name]').val(data['name']);
              modal.find('input[name=continuous]').val(data['continuous']);
              modal.find('input[name=impulse]').val(data['impulse']);
              modal.find('input[name=remaining]').val(data['remaining']);
            });

          });


          $('#modalPumpCal button[name=save]').click(function() {

            id = $('#modalPumpCal input[name=id]').val();

            cal = {
              'name': $('#modalPumpCal input[name=name]').val(),
              'continuous': parseFloat($('#modalPumpCal input[name=continuous]').val()),
              'impulse': parseFloat($('#modalPumpCal input[name=impulse]').val()),
              'remaining': parseFloat($('#modalPumpCal input[name=remaining]').val())
            }

            $.put('/api/pumps/cal/'+id, cal, function(data) {
              updatePumpTable(data.cal);
              $('#modalPumpCal').modal('hide');
            }).error(function(data) {
              $('#modalPumpCal #errorMsg').text(data.responseJSON.msg);
              $('#modalPumpCal #errorMsg').removeClass('hidden');
            });

          });

          $('#calibrateContinuous').click(function (event) {
            event.preventDefault();
            id = $(this).closest('form').find('input[name=id]').val();

            $.put('/api/pumps/state/'+id, {'state': 'calibrateContinuous'}, function(data) {
            })

          });

          $('#calibrateImpulse').click(function (event) {
            event.preventDefault();
            id = $(this).closest('form').find('input[name=id]').val();

            $.put('/api/pumps/state/'+id, {'state': 'calibrateImpulse'}, function(data) {
            })

          });


          $('#endMaintenance').click(function (event) {
            event.preventDefault();


            $('#maintenanceForm').find('.pump-amount').each(function() {
              if (!$(this).val()) {
                return;
              }
              $.put('/api/pumps/state/'+$(this).data('pump'), {'state': 'run', 'amount': $(this).val()}, function(data) {

              });
            });

            // TODO we should actually enter and exit Maintenance mode...
            $('#modalMaintenance').modal('hide');

          });

          $('#modalPhCal button[name=save]').click(function() {

            cal = {
              'pH1': parseFloat($('#modalPhCal input[name=pH1]').val()),
              'pH2': parseFloat($('#modalPhCal input[name=pH2]').val()),
              'mV1': parseFloat($('#modalPhCal input[name=mV1]').val()),
              'mV2': parseFloat($('#modalPhCal input[name=mV2]').val()),
              'kH': parseFloat($('#modalPhCal input[name=kH]').val())
            }

            $.put('/api/ph/cal', cal, function(data) {
              $('#modalPhCal').modal('hide');
              $('#modalPhCal #errorMsg').addClass('hidden');

              kH = parseFloat(data['kH']);
              updatePHlist();

            }).error(function(data) {
              $('#modalPhCal #errorMsg').text(data.responseJSON.msg);
              $('#modalPhCal #errorMsg').removeClass('hidden');
            });

          });

          $('#modalPumpNode').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget) // Button that triggered the modal
            var id = button.data('id') // Extract info from data-* attributes

            var modal = $(this)

            if (id == -1) {
              // New Node
              modal.find('.modal-title').text('Düngung erstellen');
              modal.find('input[name=time]').val('');
              modal.find('input[name=id]').val(-1);
              modal.find('select[name=pump]').val('');
              modal.find('input[name=amount]').val('');
              modal.find('button[name=delete]').addClass('hidden');

            } else {

              modal.find('.modal-title').text('Düngung bearbeiten');
              modal.find('input[name=time]').val('');
              modal.find('input[name=id]').val('');
              modal.find('select[name=pump]').val('');
              modal.find('input[name=amount]').val('');
              modal.find('button[name=delete]').removeClass('hidden');


              $.get('/api/pumps/nodes/'+id, function(data){
                 modal.find('.modal-title').text(`Düngung ${data.node['time']} Uhr bearbeiten`);
                 modal.find('input[name=time]').val(data.node['time']);
                 modal.find('input[name=id]').val(data.node['id']);
                 modal.find('select[name=pump]').val(data.node['pump']);
                 modal.find('input[name=amount]').val(data.node['amount']);
              });
            }

          });

          $('#modalPumpNode button[name=delete]').click(function() {
            node = $('#modalPumpNode input[name=id]').val();
            $.delete('/api/pumps/nodes/'+node, function(data) {
              updatePumpNodes(data.nodes);
              $('#modalPumpNode').modal('hide');
            });
          });

          $('#modalPumpNode button[name=save]').click(function() {
            node = $('#modalPumpNode input[name=id]').val();
            nodeData = {
              'pump': parseInt($('#modalPumpNode select[name=pump]').val()),
              'amount': parseFloat($('#modalPumpNode input[name=amount]').val()),
              'time': $('#modalPumpNode input[name=time]').val()
            };

            console.log(nodeData);

            if (node == -1) {
              // New node

              console.log(node);
              $.jsonPost('/api/pumps/nodes', nodeData , function(data) {
                updatePumpNodes(data.nodes);
                $('#modalPumpNode').modal('hide');
              }).error(function(data) {
                $('#modalPumpNode #errorMsg').text(data.responseJSON.msg);
                $('#modalPumpNode #errorMsg').removeClass('hidden');
              });

            } else {
              // edit node

              $.put('/api/pumps/nodes/'+node, nodeData, function(data) {
                updatePumpNodes(data.nodes);
                $('#modalPumpNode').modal('hide');
              }).error(function(data) {
                $('#modalPumpNode #errorMsg').text(data.responseJSON.msg);
                $('#modalPumpNode #errorMsg').removeClass('hidden');
              });

            }

          });

          $('#modalLightNode').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget) // Button that triggered the modal
            var id = button.data('id') // Extract info from data-* attributes

            var modal = $(this)

            if (id == -1) {
              // New Node
              modal.find('.modal-title').text('Ansteuerpunkt erstellen');
              modal.find('input[name=time]').val('');
              modal.find('input[name=id]').val(-1);
              modal.find('input[name=brightness]').slider('setValue', 0.0);
              modal.find('button[name=delete]').addClass('hidden');

            } else {

              modal.find('.modal-title').text('Ansteuerpunkt bearbeiten');
              modal.find('input[name=time]').val('');
              modal.find('input[name=id]').val('');
              modal.find('input[name=brightness]').slider('setValue', 0.0);
              modal.find('button[name=delete]').removeClass('hidden');


              $.get('/api/light/nodes/'+id, function(data){
                 modal.find('.modal-title').text(`Ansteuerpunkt ${data.node['time']} Uhr - ${Math.round(data.node['brightness']*100)}% bearbeiten`);
                 modal.find('input[name=time]').val(data.node['time']);
                 modal.find('input[name=id]').val(data.node['id']);
                 modal.find('input[name=brightness]').slider('setValue', data.node['brightness']);
              });
            }

          });

          $('#modalLightNode button[name=delete]').click(function() {
            node = $('#modalLightNode input[name=id]').val();
            $.delete('/api/light/nodes/'+node, function(data) {
              updateLightNodes(data.nodes);
              $('#modalLightNode').modal('hide');
            });
          });

          $('#modalLightNode button[name=save]').click(function() {
            node = $('#modalLightNode input[name=id]').val();

            nodeData = {
              'brightness': $('#modalLightNode input[name=brightness]').slider('getValue'),
              'time':       $('#modalLightNode input[name=time]').val()
            }

            if ($('#modalLightNode input[name=id]').val() == -1) {
              // New node

              console.log(node);
              $.jsonPost('/api/light/nodes', nodeData , function(data) {
                updateLightNodes(data.nodes);
                $('#modalLightNode').modal('hide');
              }).error(function(data) {
                $('#modalLightNode #errorMsg').text(data.responseJSON.msg);
                $('#modalLightNode #errorMsg').removeClass('hidden');
              });

            } else {
              // edit node

              $.put('/api/light/nodes/'+node, nodeData, function(data) {
                updateLightNodes(data.nodes);
                $('#modalLightNode').modal('hide');
              }).error(function(data) {
                $('#modalLightNode #errorMsg').text(data.responseJSON.msg);
                $('#modalLightNode #errorMsg').removeClass('hidden');
              });

            }

          });

        });

        </script>

        <script src="js/main.js"></script>
    </body>
</html>
